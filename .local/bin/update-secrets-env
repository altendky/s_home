#!/usr/bin/env bash
set -euo pipefail

SECRETS_FILE="$HOME/.secrets.env"

# Sync and unlock Bitwarden
echo "Syncing Bitwarden vault..." >&2
bw sync

echo "Unlocking Bitwarden vault..." >&2
BW_SESSION=$(bw unlock --raw)
export BW_SESSION

# Get the folder ID for "shell-env"
FOLDER_ID=$(bw list folders --session "$BW_SESSION" \
    | jq -r '.[] | select(.name == "shell-env") | .id')

if [[ -z "$FOLDER_ID" ]]; then
    echo "Error: Folder 'shell-env' not found in Bitwarden" >&2
    exit 1
fi

# List items in the folder and generate Fish export lines
SECRETS=$(bw list items --folderid "$FOLDER_ID" --session "$BW_SESSION" \
    | jq -r '.[] | "set -gx " + .name + " \"" + (.notes // "" | gsub("\\\\"; "\\\\") | gsub("\""; "\\\"")) + "\""')

if [[ -z "$SECRETS" ]]; then
    echo "Error: No items found in 'shell-env' folder" >&2
    exit 1
fi

# Write to ~/.secrets.env
cat > "$SECRETS_FILE" << 'EOF'
# Auto-generated - do not edit manually
# Regenerate by running: update-secrets-env

EOF

echo "$SECRETS" >> "$SECRETS_FILE"

echo "Updated $SECRETS_FILE with $(echo "$SECRETS" | wc -l) secret(s)" >&2
